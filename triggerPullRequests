pipeline {
    agent any

    stages {
        stage('Run Tests') {
            when {
                beforeAgent true // Run only if a node is available
                anyOf {
                    // Run on pull request event
                    expression {
                        github.event_name == 'pull_request'
                    }
                    // Run on push event to main branch
                    expression {
                        github.event_name == 'push' && github.ref == 'refs/heads/main'
                    }
                }
            }
            steps {
                script {
                    sh "pytest" 
                }
            }
        }
    }

    post {
            always {
                // Always clean the workspace regardless of the build result
                deleteDir()
            }
        }
}
